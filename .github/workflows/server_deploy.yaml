name: Deploy on Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: Server Deployment
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e

            log_section () {
              echo ""
              echo "=================================================="
              echo "▶ $1"
              echo "=================================================="
            }

            log_ok () {
              echo "✔ SUCCESS: $1"
            }

            log_warn () {
              echo "⚠ WARNING: $1"
            }

            log_fail () {
              echo "✖ ERROR: $1"
            }

            log_section "DEPLOYMENT STARTED"

            log_section "CHECKING REPOSITORY"
            if [ ! -d "$HOME/perso/email-sender" ]; then
              log_warn "Repository not found. Cloning..."
              mkdir -p "$HOME/perso"
              cd "$HOME/perso"
              git clone https://github.com/Nick-Lemy/email-sender
              log_ok "Repository cloned"
            else
              log_ok "Repository already exists"
            fi

            log_section "UPDATING CODE"
            cd "$HOME/perso/email-sender"
            git pull origin main
            log_ok "Latest code pulled"

            log_section "DOCKER DEPLOYMENT"
            sudo docker stop email-sender || log_warn "Container not running"
            sudo docker rm email-sender || log_warn "Container not found"
            sudo docker build -t email-sender .
            log_ok "Docker image built"

            sudo docker run -d --name email-sender -p 80:80 email-sender
            log_ok "Container started"

            log_section "HEALTH CHECK"
            for i in {1..10}; do
              echo "→ Health check attempt $i/10"
              if curl -sf localhost/health | grep -q "OK"; then
                log_ok "Service is healthy"
                log_section "DEPLOYMENT COMPLETED SUCCESSFULLY"
                exit 0
              fi
              sleep 3
            done

            log_fail "Service failed health check after multiple attempts"
            echo ""
            echo "---- Last container logs ----"
            sudo docker logs email-sender || true
            echo "-----------------------------"

            log_section "DEPLOYMENT FAILED"
            exit 1
